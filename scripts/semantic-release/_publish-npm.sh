#!/bin/sh

default()
{
  # Add paths to env (non-Travis build)
  if [ -z "$TRAVIS" ]; then
    PATH=/usr/local/bin:/usr/bin:/bin:$PATH
    export PATH
  fi

  SCRIPT=`basename $0`
  SCRIPT_DIR=`dirname $0`
  SCRIPT_DIR=`cd $SCRIPT_DIR; pwd`

  . $SCRIPT_DIR/../_env.sh
  . $SCRIPT_DIR/../_common.sh
  . $SCRIPT_DIR/_common.sh

  BUILD_DIR=$TRAVIS_BUILD_DIR
}

# Check prerequisites before continuing
#
prereqs()
{
  merge_prereqs

  if [ ! -s "$PACKAGE_JSON" -o ! -s "$BOWER_JSON" ]; then
    echo "*** Cannot locate $PACKAGE_JSON or $BOWER_JSON. Do not bump!"
    exit 1
  fi

  # Get version generated by 'semantic-release pre'
  VERSION=`grep '"version"' $PACKAGE_JSON | \
    awk -F':' '{print $2}' | \
    sed 's|\"||g' | \
    sed 's|,||g' | \
    sed 's| *||g'`

  BOWER_VERSION=`grep '"version"' $BOWER_JSON | \
    awk -F':' '{print $2}' | \
    sed 's|\"||g' | \
    sed 's|,||g' | \
    sed 's| *||g'`

  if [ "$VERSION" != "$BOWER_VERSION" ]; then
    echo "*** The $PACKAGE_JSON and $BOWER_JSON versions differ. Do not publish!"
    exit 1
  fi
}

# Publish npm
#
# $1 subdirectory to publish from
publish_npm()
{
  echo "*** Publishing npm"
  cd $BUILD_DIR/$1

  if [ -f "$BUILD_DIR/$SKIP_NPM_PUBLISH" ]; then
    echo "*** Found $SKIP_NPM_PUBLISH file indicator. Do not publish!"
    exit 1
  fi

  npm publish
  check $? "npm publish failure"
}


# Publish npm from dist directory
#
publish_npm_dist() {
  echo "*** Copying files to dist"
  cd $BUILD_DIR/$DIST_DIR

  cp -r $BUILD_DIR/$GIT_DIR $DIST_DIR
  check $? "Copy $GIT_DIR failure"

  cp $BUILD_DIR/$PACKAGE_JSON $DIST_DIR
  check $? "Copy $PACKAGE_JSON failure"

  cp $BUILD_DIR/$SHRINKWRAP_JSON $DIST_DIR
  check $? "Copy $SHRINKWRAP_JSON failure"

  node $BUILD_DIR/node_modules/semantic-release/bin/semantic-release.js pre
  check $? "semantic-release pre failure"

  publish_npm $DIST_DIR

  node $BUILD_DIR/node_modules/semantic-release/bin/semantic-release.js post
  check $? "semantic-release post failure"
}

usage()
{
cat <<- EEOOFF

    This script ensures both $PACKAGE_JSON and $BOWER_JSON have been updated prior to publishing to npm

    Note: The sematic-release command is run only when publishing from the $DIST subdirectory.

    sh [-x] $SCRIPT [-h|d]

    Example: sh $SCRIPT -d

    OPTIONS:
    h       Display this message (default)
    d       Publish from $DIST directory

EEOOFF
}

# main()
{
  default

  while getopts hd c; do
    case $c in
      h) usage; exit 0;;
      d) PUBLISH_DIST=1;;
      \?) usage; exit 1;;
    esac
  done

  prereqs

  if [ -n "$PUBLISH_DIST" ]; then
    publish_npm_dist
  else
    publish_npm
  fi
}
